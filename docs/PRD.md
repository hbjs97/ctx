# PRD.md

## 1. 문서 정보

- 문서명: GitHub 멀티계정 컨텍스트 매니저(PRD)
- 버전: v1.0
- 작성일: 2026-02-14
- 대상: 개인 계정 + 회사 계정을 동시에 사용하는 개발자
- 제품 가칭: `ctx`

## 2. 배경과 문제 정의

현재 GitHub CLI(`gh`)는 `github.com` 기준 다중 계정 로그인은 가능하지만 활성 계정은 1개다.  
실무에서는 아래 3개 레이어가 분리되어 동작해 혼선이 발생한다.

1. `gh` 인증 계정(활성 계정)
2. `git` 전송 계층(HTTPS credential helper 또는 SSH key)
3. 커밋 신원(`user.name`, `user.email`)

대표적인 문제는 다음과 같다.

1. 계정 전환 시 `gh auth switch` + `gh auth setup-git` + 상태 확인이 반복되어 UX/DX가 나쁨
2. `gh`는 회사 계정인데 `git`은 개인 keychain/SSH 키를 사용해 권한 에러 발생
3. 클론 시점에는 회사/개인 리포인지 불명확한 경우가 있어 분류 실패
4. 잘못된 계정으로 PR/Push/코멘트가 올라가는 운영 리스크 존재
5. SAML SSO, fine-grained PAT, 다중 SSH 키 등으로 디버깅 난이도 상승

## 3. 제품 목표

### 3.1 목표

1. 계정 선택을 “수동 전환”에서 “컨텍스트 자동 결정”으로 전환
2. 잘못된 계정으로의 push/PR 발생을 원천 차단(실수 방지)
3. 클론부터 작업 시작까지 최소 명령으로 단축
4. 현재 어떤 계정이 왜 선택되었는지 설명 가능성 확보

### 3.2 비목표

1. `gh`, `git`, `ssh` 자체를 대체하지 않음
2. 토큰 저장소(Keychain, `gh auth`)를 자체 구현하지 않음
3. GitHub 웹 기능(PR 리뷰 UI, 이슈 UI) 자체를 재구현하지 않음

## 4. 타깃 사용자

1. 개인/회사 GitHub 계정을 모두 사용하는 개발자
2. 조직 권한이 엄격하게 분리된 환경(SAML SSO 포함)
3. 여러 리포를 빠르게 오가며 작업하는 엔지니어

## 5. 핵심 사용 시나리오

1. 사용자가 모르는 리포를 클론한다.
2. 도구가 계정을 자동 판정한다.
3. 모호하면 1회 질문 후 결과를 캐시한다.
4. 클론 직후 올바른 remote/커밋 신원/가드가 자동 적용된다.
5. 이후에는 같은 리포에서 추가 전환 없이 작업한다.
6. push 시 컨텍스트가 다르면 차단하고 수정 명령을 제시한다.

## 6. 범위

### 6.1 MVP 범위

1. 프로필 정의(회사/개인)
2. `ctx clone` 자동 계정 판정
3. 리포-계정 매핑 캐시
4. `ctx status` 단일 진단 화면
5. pre-push 가드
6. 모호 케이스 fail-closed 처리
7. `gh`/`git`/`ssh` 상태 점검(`ctx doctor`)
8. 프로필 관리(`ctx setup`)
9. 기존 리포 프로필 적용(`ctx init`)

### 6.2 MVP 이후

1. GitHub Enterprise 다중 호스트 고급 정책
2. 팀 단위 중앙 정책 배포
3. GUI 제공

## 7. 기능 요구사항

| ID    | 요구사항                                   | 우선순위 | 수용 기준                                                                  |
| ----- | ------------------------------------------ | -------- | -------------------------------------------------------------------------- |
| FR-01 | 프로필을 회사/개인으로 분리 관리           | Must     | 각 프로필에 `gh_config_dir`, `ssh_host`, `git_name`, `git_email` 저장 가능 |
| FR-02 | `ctx clone`이 URL/`owner/repo`를 모두 지원 | Must     | 두 입력 형태 모두 clone 성공                                               |
| FR-03 | 계정 판정 우선순위 적용                    | Must     | `명시 플래그 > 캐시 > owner 규칙 > 권한 probe > 사용자 선택` 순서 고정     |
| FR-04 | 권한 probe로 read/push 가능성 확인         | Must     | 최소 2개 프로필 대상 probe 결과를 표시하고 선택 근거 출력                  |
| FR-05 | 모호 시 자동 진행 금지                     | Must     | 비대화형 모드에서 모호하면 에러 종료                                       |
| FR-06 | 선택 결과 캐시                             | Must     | 동일 리포 재시도 시 재질문 없이 동일 계정 적용                             |
| FR-07 | 클론 후 리포 로컬 git identity 자동 설정   | Must     | `.git/config`에 올바른 `user.name/email` 반영                              |
| FR-08 | pre-push 가드 제공                         | Must     | 리포 기대 계정과 실제 컨텍스트 불일치 시 push 차단                         |
| FR-09 | 단일 상태 화면 제공                        | Must     | 현재 계정, remote, SSH host, commit identity, 선택 근거를 1회 출력         |
| FR-10 | 기존 리포 프로필 적용(`ctx init`)          | Must     | 기존 리포에 대해 프로필 연결 및 가드 설치 가능                             |
| FR-11 | `gh`/`git` 자격 증명 충돌 진단             | Should   | HTTPS helper 충돌, env token 우선순위 이슈 감지                            |
| FR-12 | SAML/fine-grained PAT 실패 힌트            | Should   | 권한 실패 메시지에 원인 후보와 액션 제시                                   |
| FR-13 | 프로필 관리(`ctx setup`)                   | Must     | 프로필 추가/관리를 인터랙티브로 수행. 재실행으로 계정 추가 가능            |
| FR-14 | Shell 통합(자동)                           | Should   | `ctx setup` 시 셸 hook 자동 설정. `gh` 사용 시 `GH_CONFIG_DIR` 자동 주입  |

## 8. 비기능 요구사항

| ID     | 요구사항 | 기준                                            |
| ------ | -------- | ----------------------------------------------- |
| NFR-01 | 보안     | 토큰 평문 저장 금지, 민감 정보 로그 마스킹      |
| NFR-02 | 신뢰성   | 모호한 판정은 항상 fail-closed                  |
| NFR-03 | 성능     | 캐시 히트 시 `ctx status` 300ms 이내(로컬 기준) |
| NFR-04 | 이식성   | macOS 우선, Linux 지원                          |
| NFR-05 | 가시성   | 선택 계정의 “판정 이유”를 항상 출력             |

## 9. UX/DX 원칙

1. 전환 명령을 줄이고 컨텍스트 자동화를 기본값으로 한다.
2. 계정 선택 결과는 항상 “왜 그렇게 선택됐는지” 설명한다.
3. 위험 동작(push)은 차단 우선, 우회는 명시 옵션으로만 허용한다.
4. 기존 도구(`gh`, `git`, `ssh`)와 호환되는 얇은 래퍼로 설계한다.

## 10. 엣지 케이스와 대응 정책

| 케이스                             | 리스크                  | 대응                                          |
| ---------------------------------- | ----------------------- | --------------------------------------------- |
| 같은 리포에 두 계정 모두 접근 가능 | 오선택 push             | 자동 진행 금지, 1회 선택 후 캐시              |
| 리포 밖에서 `gh` 실행              | 컨텍스트 없음           | `--account` 요구 또는 기본 프로필 명시        |
| `GH_TOKEN`이 설정됨                | 저장된 로그인 무시      | 상태 화면에 env token 우선 사용 경고          |
| HTTPS credential helper 충돌       | 권한 오류               | SSH 기본화 또는 helper 정리 가이드            |
| SAML SSO 미인가                    | 로그인 되어도 접근 실패 | SSO authorize 안내 메시지                     |
| fine-grained PAT 범위 제한         | 리포별 불규칙 실패      | 스코프 점검 안내 + 권한 probe 상세화          |
| 커밋 이메일 누수                   | 정책 위반               | 로컬 repo identity 강제 설정 + 검사           |
| SSH agent 다중 키 혼선             | 오인증                  | `IdentitiesOnly` 권장/검사                    |
| `includeIf`/worktree/symlink 차이  | 프로필 미적용           | `ctx`의 repo 메타데이터를 우선 신뢰           |
| submodule/보조 remote              | 부분 실패               | submodule/remote까지 동일 계정 일괄 적용 옵션 |

## 11. 성공 지표(KPI)

| 지표                  | 기준선(현재) | 목표(MVP 4주 후) |
| --------------------- | ------------ | ---------------- |
| 계정 전환 명령 수     | 작업당 2~3회 | 0~1회            |
| 잘못된 계정 push/PR   | 월 N건       | 0건              |
| 새 환경 세팅 시간     | 30~60분      | 10분 이내        |
| 권한 오류 디버깅 시간 | 건당 10~20분 | 3분 이내         |

## 12. 릴리즈 계획

1. Alpha(개인 사용): 핵심 명령 `setup/clone/init/status` 검증
2. Beta(소규모 팀): 엣지 케이스 및 가드 안정화
3. GA: 문서화, 설치 스크립트, 운영 체크리스트 배포

## 13. 리스크와 완화

1. `gh` 출력 포맷 변경 리스크: 공식 API/JSON 출력 사용 우선
2. 훅 충돌 리스크: 기존 훅 체이닝 및 백업
3. 사용자 우회 리스크: 우회 시 명시 플래그 + 감사 로그(로컬)
4. 과도한 자동화 리스크: 모호 상황은 절대 자동 확정 금지

## 14. 최종 제품 원칙(의사결정)

본 제품의 핵심 원칙은 “전환(switch)” 최소화가 아니라 “분리 + 자동 판정 + 실수 방지”다.  
즉, 폴더 규칙 단독 의존이 아니라 `owner 매핑 + 권한 probe + 캐시 + push guard`의 조합을 기본 전략으로 채택한다.
